$response.setContentType("application/x-json")
#set( $offset = $xwiki.parseInt( $request.get( "offset" ) ) )
## offset starts from 0 in velocity and 1 in javascript
#set( $off = $offset - 1 )
#set( $limit = $xwiki.parseInt( $request.get( "limit" ) ) )

#set( $rm = $xwiki.rightsmanager.groupsApi )

#### get all the request parameters which are filters
#set( $params = $request.getParameterMap() )
#set( $keys = $params.keySet() )
#set( $defaultKeys = ["xpage", "offset", "limit", "wiki", "reqNo"] )
#set( $docProps = ["fullName", "name"] )
#set( $filterMap = $xwiki.hashMap )
#set( $orderList = $xwiki.arrayList )
#foreach( $key in $keys )
  #if(! $defaultKeys.contains( $key ) )
     ## build the filters map
     #foreach( $i in $params.get( $key ) ) #set( $value = $i ) #end
     #if( $docProps.contains( $key )) 
        #set( $arr = $xwiki.arrayList )
        #set( $discard = $arr.add( null ) ) ## this may be variable...
        #set( $discard = $arr.add( "$value" ) )
        #set( $discard = $filterMap.put("$key", $arr))
        #set( $discard = $orderList.add( "$key" ))
     #else
        #set( $arr = $xwiki.arrayList )
        #set( $discard = $arr.add( "StringProperty" ) ) ## this may be variable...
        #set( $discard = $arr.add( "$value" ) )
        #set( $discard = $filterMap.put("$key", $arr))
		#set( $arr2 = $xwiki.arrayList )
        #set( $discard = $arr2.add( "$key" ) )
        #set( $discard = $arr2.add( "StringProperty" ) )
        #set( $discard = $orderList.add( $arr2 ))
     #end
  #end
#end

#if($orderList.size() == 0)
#set($disc = $orderList.add("name")) ## initially fiter by "name" !!!
#end

#foreach( $i in $params.get( "wiki" ) ) #set( $value = $i ) #end
#if( $value == "local" )
  #set( $users = $rm.getAllMatchedLocalGroups( $filterMap, $limit, $off, $orderList ) )
  #set( $countUsers = $rm.countAllMatchedLocalGroups( $filterMap ) )
#elseif( $value == "global" )
  #set( $users = $rm.getAllMatchedGlobalGroups( $filterMap, $limit, $off, $orderList ) )
  #set( $countUsers = $rm.countAllMatchedGlobalGroups( $filterMap ) )
#else
  ## get both local and global users
  #set( $users = $rm.getAllMatchedGroups( $filterMap, $limit, $off, $orderList ) )
  #set( $countUsers = $rm.countAllMatchedGroups( $filterMap ) )
#end

### json starts
{
"totalrows": $countUsers,
"returnedrows": #if($countUsers < $limit) $countUsers #else $limit #end,
"offset": $offset,
"reqNo": $request.reqNo,
"rows": [
#foreach( $user in $users )
  #set($wikiname = $user.getWiki())
  #if($wikiname != "xwiki" || $wikiname == $context.database) #set($wikiname = "local") #end
   #set( $grs = $xwiki.rightsmanager.getAllGroupsForUser( $user.fullName ) )
   #if( $velocityCount > 1 ) , #end
   {"username"      : "$user.name", 
    "fullname"      : "$user.fullName",
    "wikiname"      : "$wikiname",
    "members"       : "$xwiki.getDocument($user.fullName).getObjects("XWiki.XWikiGroups").size()", 
    "userurl"       : "$xwiki.getURL($user.fullName)",
    "usersaveurl"   : "$user.getURL('save')",
    "userinlineurl" : "$user.getURL("inline", "xpage=editgroup")",
    "docurl"        : "$xwiki.getURL("XWiki.XWikiGroups", "admin", "editor=groups&space=XWiki")"
  }
#end
]}
### end of json

